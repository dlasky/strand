<script>
/**
 * @license
 * Copyright (c) 2015 MediaMath Inc. All rights reserved.
 * This code may only be used under the BSD style license found at http://mediamath.github.io/strand/LICENSE.txt

*/
(function (scope) {

	var _w = 10000, 
		_instances = {
		modal:{
			base:1*_w,
			max:2*_w,
			items: new Set(),
			topIndex:1*_w
		},
		ui:{
			base:2*_w,
			max:3*_w,
			items: new Set(),
			topIndex:2*_w
		},
		tooltip:{
			base:3*_w,
			max:4*_w,
			items: new Set(),
			topIndex:3*_w
		}
	};

	function _addInstance(host, instance, type) {
		var cat = _instances[type],
			inst = !instance ? host : instance;

		if (cat && cat.items.size < cat.max) {
			cat.items.add(inst);
			host._setDepth(cat.topIndex);
			cat.topIndex++;
		} else {
			throw(new Error("Could not add item at " + cat.max));
		}
	}

	function _removeInstance(host, instance, newType, oldType) {
		var cat = !oldType ? _instances[newType] : _instances[oldType],
			inst = !instance ? host : instance;

		if (cat) {
			cat.items.delete(inst);
		}
	}

	scope.Stackable = {

		properties: {
			_stackHost: {
				type: Object,
				value: null,
				observer: "_stackHostChanged"
			},
			_stackTarget: {
				type: Object,
				value: null,
				observer: "_stackTargetChanged"
			},
			depth: {
				readOnly: true,
				notify: true,
				type: Number,
				value: 0,
				observer: "_updateDepth"
			},
			stackType:{
				type: String,
				value: "ui",
				observer:"_updateType"
			}
		},

		attached: function() {
			if (!this._stackHost) this._stackHost = this;
		},

		detached: function() {
			_removeInstance(this._stackHost, this._stackTarget, this.stackType);
		},

		_stackHostChanged: function(newVal, oldVal) {
			if (newVal) this.debounce('updateStack', this._updateStack);
		},

		_stackTargetChanged: function(newVal, oldVal) {
			if (newVal) this.debounce('updateStack', this._updateStack);
		},

		_updateDepth: function(newVal, oldVal) {
			var target = this._stackTarget ? this._stackTarget : this._stackHost;
			if (target) {
				this._stackTarget.style.setProperty("z-index", this.depth);
			}
		},

		_updateType: function(newType, oldType) {
			if (newType) this._updateStack(newType, oldType);
		},

		moveToTop: function() {
			this.debounce('updateStack', this._updateStack);
			return this.depth;
		},

		_updateStack: function(newType, oldType) {
			var target = this._stackTarget ? this._stackTarget : this._stackHost;
			if (target) {
				var newStackType = !newType ? this.stackType : newType,
					oldStackType = !oldType ? null : oldType;

				_removeInstance(this._stackHost, this._stackTarget, newStackType, oldStackType);
				_addInstance(this._stackHost, this._stackTarget, newStackType);
			}
		}
	};

})(window.StrandTraits = window.StrandTraits || {}); 
</script>